name: Create Release Issue

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Target network'
        required: true
        type: choice
        options:
          - Calibnet
          - Mainnet
      upgrade_type:
        description: 'Type of upgrade'
        required: true
        type: choice
        options:
          - Routine
          - Breaking Change
      upgrade_registry:
        description: '(Rare) Also upgrading ServiceProviderRegistry?'
        required: false
        type: boolean
        default: false
      upgrade_state_view:
        description: '(Rare) Also redeploying FilecoinWarmStorageServiceStateView?'
        required: false
        type: boolean
        default: false
      after_epoch:
        description: 'AFTER_EPOCH (block number after which upgrade can execute)'
        required: true
        type: string
      changelog_pr:
        description: 'PR number with changelog updates'
        required: true
        type: string
      changes_summary:
        description: 'Summary of changes (use | for multiple lines)'
        required: true
        type: string
      action_required:
        description: 'Action required for integrators (or "None" if no action needed)'
        required: true
        type: string
        default: 'None'
      release_tag:
        description: 'Release tag if already created (usually added after upgrade completes)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (preview issue without creating)'
        required: false
        type: boolean
        default: false

jobs:
  create-announcement:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create announcement issue
        id: create_issue
        env:
          NETWORK: ${{ inputs.network }}
          UPGRADE_TYPE: ${{ inputs.upgrade_type }}
          UPGRADE_REGISTRY: ${{ inputs.upgrade_registry }}
          UPGRADE_STATE_VIEW: ${{ inputs.upgrade_state_view }}
          AFTER_EPOCH: ${{ inputs.after_epoch }}
          CHANGELOG_PR: ${{ inputs.changelog_pr }}
          CHANGES_SUMMARY: ${{ inputs.changes_summary }}
          ACTION_REQUIRED: ${{ inputs.action_required }}
          RELEASE_TAG: ${{ inputs.release_tag }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            node .github/scripts/create-upgrade-announcement.js --dry-run
          else
            node .github/scripts/create-upgrade-announcement.js
          fi

      - name: Summary
        run: |
          echo "## Release Issue ${{ inputs.dry_run == true && '(Dry Run)' || 'Created' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Network**: ${{ inputs.network }}" >> $GITHUB_STEP_SUMMARY
          echo "**After Epoch**: ${{ inputs.after_epoch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "This was a dry run. No issue was created." >> $GITHUB_STEP_SUMMARY
          else
            echo "See the created issue for full details." >> $GITHUB_STEP_SUMMARY
          fi
